name: build-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build-type:
        description: "manual override of build type"
        required: false
        default: "release"

permissions:
  contents: write

jobs:
  build-windows:
    name: Build (exe) on Windows
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag.TrimStart('v')
          "value=$version" >> $Env:GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore
        run: dotnet restore LLWallPaper.sln

      - name: Publish (self-contained)
        run: >-
          dotnet publish .\LLWallPaper.App\LLWallPaper.App.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:DebugType=none
          -p:DebugSymbols=false
          -p:Version=${{ steps.version.outputs.value }}
          -o publish

      - name: Remove PDBs
        shell: pwsh
        run: |
          $publish = 'LLWallPaper.App\bin\Release\net10.0-windows\win-x64\publish'
          Get-ChildItem -Path $publish -Filter *.pdb -Recurse | Remove-Item -Force

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk --version 0.0.1298

      - name: Download previous releases (for delta)
        shell: pwsh
        run: >-
          vpk download github
          --repoUrl https://github.com/${{ github.repository }}
          --token ${{ secrets.GITHUB_TOKEN }}

      - name: Pack Velopack release
        shell: pwsh
        run: >-
          vpk pack
          --packId AkaakuHub.LLWallPaper
          --packVersion ${{ steps.version.outputs.value }}
          --packDir publish
          --mainExe LLWallPaper.App.exe

      - name: Upload Velopack release to GitHub
        shell: pwsh
        run: >-
          vpk upload github
          --repoUrl https://github.com/${{ github.repository }}
          --token ${{ secrets.GITHUB_TOKEN }}
          --publish
          --releaseName "v${{ steps.version.outputs.value }}"
          --tag v${{ steps.version.outputs.value }}
